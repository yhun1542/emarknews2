<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>EmarkNews - AI 기반 글로벌 뉴스 포털 (Premium v3.0.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#7c3aed',
                    }
                }
            }
        }
    </script>
    <style>
        .news-card {
            transition: all 0.3s ease;
        }
        .news-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <!-- 헤더 -->
    <header class="bg-white dark:bg-gray-800 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-primary dark:text-blue-400">
                        📰 EmarkNews
                    </h1>
                    <span class="text-sm text-gray-500 dark:text-gray-400">
                        AI 기반 글로벌 뉴스 포털
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="refreshBtn" class="btn btn-primary btn-sm">
                        🔄 업데이트
                    </button>
                    <button id="themeToggle" class="btn btn-ghost btn-sm">
                        🌙
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 로딩 상태 -->
        <div id="loadingState" class="text-center py-12">
            <div class="loading">
                <div class="text-4xl mb-4">📡</div>
                <p class="text-lg text-gray-600 dark:text-gray-400">뉴스를 불러오는 중...</p>
            </div>
        </div>

        <!-- 트렌딩 키워드 -->
        <section id="trendingSection" class="mb-8 hidden">
            <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">
                🔥 트렌딩 키워드
            </h2>
            <div id="trendingKeywords" class="flex flex-wrap gap-2">
                <!-- 트렌딩 키워드가 여기에 표시됩니다 -->
            </div>
        </section>

        <!-- 뉴스 섹션들 -->
        <div id="newsContainer" class="space-y-12 hidden">
            <!-- 세계뉴스 -->
            <section id="worldNews" class="news-section">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200 border-b-2 border-primary pb-2">
                    🌍 세계뉴스
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="worldNewsGrid">
                    <!-- 뉴스 카드들이 여기에 표시됩니다 -->
                </div>
            </section>

            <!-- 한국뉴스 -->
            <section id="koreaNews" class="news-section">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200 border-b-2 border-secondary pb-2">
                    🇰🇷 한국뉴스
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="koreaNewsGrid">
                    <!-- 뉴스 카드들이 여기에 표시됩니다 -->
                </div>
            </section>

            <!-- 일본뉴스 -->
            <section id="japanNews" class="news-section">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200 border-b-2 border-green-500 pb-2">
                    🇯🇵 일본뉴스
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="japanNewsGrid">
                    <!-- 뉴스 카드들이 여기에 표시됩니다 -->
                </div>
            </section>
        </div>

        <!-- 에러 상태 -->
        <div id="errorState" class="text-center py-12 hidden">
            <div class="text-4xl mb-4">❌</div>
            <p class="text-lg text-red-600 dark:text-red-400 mb-4">뉴스를 불러오는 중 오류가 발생했습니다.</p>
            <button onclick="loadNews()" class="btn btn-primary">다시 시도</button>
        </div>
    </main>

    <!-- 뉴스 모달 -->
    <div id="newsModal" class="modal">
        <div class="modal-box max-w-4xl">
            <h3 id="modalTitle" class="font-bold text-lg mb-4"></h3>
            <div id="modalContent" class="py-4">
                <img id="modalImage" class="w-full h-64 object-cover rounded-lg mb-4" style="display: none;">
                <p id="modalDescription" class="text-gray-700 dark:text-gray-300 mb-4"></p>
                <div id="modalMeta" class="text-sm text-gray-500 dark:text-gray-400 mb-4"></div>
                <div id="modalKeywords" class="flex flex-wrap gap-2 mb-4"></div>
            </div>
            <div class="modal-action">
                <a id="modalLink" href="#" target="_blank" class="btn btn-primary">원문 보기</a>
                <button class="btn" onclick="closeModal()">닫기</button>
            </div>
        </div>
    </div>

    <!-- 푸터 -->
    <footer class="bg-white dark:bg-gray-800 mt-16 py-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-600 dark:text-gray-400">
                © 2024 EmarkNews. AI 기반 글로벌 뉴스 포털
            </p>
            <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">
                마지막 업데이트: <span id="lastUpdate">-</span>
            </p>
        </div>
    </footer>

    <script>
        let newsData = null;
        let isDarkMode = localStorage.getItem('darkMode') === 'true';

        // 다크모드 초기화
        if (isDarkMode) {
            document.documentElement.classList.add('dark');
            document.getElementById('themeToggle').textContent = '☀️';
        }

        // 다크모드 토글
        document.getElementById('themeToggle').addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            document.documentElement.classList.toggle('dark');
            document.getElementById('themeToggle').textContent = isDarkMode ? '☀️' : '🌙';
            localStorage.setItem('darkMode', isDarkMode);
        });

        // 새로고침 버튼
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadNews(true);
        });

        // 뉴스 로드 함수
        async function loadNews(forceRefresh = false) {
            const loadingState = document.getElementById('loadingState');
            const newsContainer = document.getElementById('newsContainer');
            const errorState = document.getElementById('errorState');
            const trendingSection = document.getElementById('trendingSection');

            // 상태 초기화
            loadingState.classList.remove('hidden');
            newsContainer.classList.add('hidden');
            errorState.classList.add('hidden');
            trendingSection.classList.add('hidden');

            try {
                // 캐시 무력화를 위한 타임스탬프 추가
                const cacheVersion = Date.now();
                const url = forceRefresh ? 
                    `/api/news?v=${cacheVersion}&_t=${cacheVersion}` : 
                    `/api/news?v=${cacheVersion}&_t=${cacheVersion}`;
                const method = forceRefresh ? 'POST' : 'GET';
                
                // 캐시 무력화 헤더 추가
                const headers = {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                };
                
                const response = await fetch(url, { 
                    method,
                    headers
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                newsData = await response.json();
                
                if (forceRefresh && newsData.data) {
                    newsData = newsData.data;
                }

                displayNews(newsData);
                displayTrending(newsData.trending || []);
                updateLastUpdate(newsData.lastUpdated);

                loadingState.classList.add('hidden');
                newsContainer.classList.remove('hidden');
                trendingSection.classList.remove('hidden');

            } catch (error) {
                console.error('뉴스 로드 오류:', error);
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
            }
        }

        // 뉴스 표시 함수
        function displayNews(data) {
            if (!data.sections) return;

            displaySection('worldNewsGrid', data.sections.world || []);
            displaySection('koreaNewsGrid', data.sections.korea || []);
            displaySection('japanNewsGrid', data.sections.japan || []);
        }

        // 섹션별 뉴스 표시
        function displaySection(gridId, articles) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';

            articles.forEach(article => {
                const card = createNewsCard(article);
                grid.appendChild(card);
            });
        }

        // 뉴스 카드 생성
        function createNewsCard(article) {
            const card = document.createElement('div');
            card.className = 'news-card bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden cursor-pointer';
            card.onclick = () => openModal(article);

            const imageHtml = article.urlToImage ? 
                `<img src="${article.urlToImage}" alt="${article.title}" class="w-full h-48 object-cover">` : 
                `<div class="w-full h-48 bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                    <span class="text-4xl">📰</span>
                </div>`;

            const stars = '⭐'.repeat(article.stars || 3);
            const category = article.category || '기타';
            const source = article.source?.name || 'Unknown';

            card.innerHTML = `
                ${imageHtml}
                <div class="p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs bg-primary text-white px-2 py-1 rounded">${category}</span>
                        <span class="text-xs text-gray-500">${stars}</span>
                    </div>
                    <h3 class="font-bold text-lg mb-2 text-gray-800 dark:text-gray-200 line-clamp-2">
                        ${article.translatedTitle || article.title}
                    </h3>
                    <p class="text-gray-600 dark:text-gray-400 text-sm mb-3 line-clamp-3">
                        ${article.translatedDescription || article.description || ''}
                    </p>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span>${source}</span>
                        <span>${formatDate(article.publishedAt)}</span>
                    </div>
                </div>
            `;

            return card;
        }

        // 트렌딩 키워드 표시
        function displayTrending(trending) {
            const container = document.getElementById('trendingKeywords');
            container.innerHTML = '';

            trending.forEach(([keyword, count]) => {
                const badge = document.createElement('span');
                badge.className = 'badge badge-outline badge-lg';
                badge.textContent = `${keyword} (${count})`;
                container.appendChild(badge);
            });
        }

        // 모달 열기
        function openModal(article) {
            document.getElementById('modalTitle').textContent = article.translatedTitle || article.title;
            document.getElementById('modalDescription').textContent = article.translatedDescription || article.description || '';
            document.getElementById('modalLink').href = article.url;

            const modalImage = document.getElementById('modalImage');
            if (article.urlToImage) {
                modalImage.src = article.urlToImage;
                modalImage.style.display = 'block';
            } else {
                modalImage.style.display = 'none';
            }

            const modalMeta = document.getElementById('modalMeta');
            modalMeta.innerHTML = `
                <div>소스: ${article.source?.name || 'Unknown'}</div>
                <div>발행일: ${formatDate(article.publishedAt)}</div>
                <div>카테고리: ${article.category || '기타'}</div>
                <div>품질점수: ${article.qualityScore || 0}/20</div>
            `;

            const modalKeywords = document.getElementById('modalKeywords');
            modalKeywords.innerHTML = '';
            if (article.keywords) {
                article.keywords.forEach(keyword => {
                    const badge = document.createElement('span');
                    badge.className = 'badge badge-primary badge-sm';
                    badge.textContent = keyword;
                    modalKeywords.appendChild(badge);
                });
            }

            document.getElementById('newsModal').classList.add('modal-open');
        }

        // 모달 닫기
        function closeModal() {
            document.getElementById('newsModal').classList.remove('modal-open');
        }

        // 날짜 포맷팅
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);

            if (diffHours < 1) return '방금 전';
            if (diffHours < 24) return `${diffHours}시간 전`;
            if (diffDays < 7) return `${diffDays}일 전`;
            
            return date.toLocaleDateString('ko-KR');
        }

        // 마지막 업데이트 시간 표시
        function updateLastUpdate(timestamp) {
            if (timestamp) {
                document.getElementById('lastUpdate').textContent = formatDate(timestamp);
            }
        }

        // 모달 외부 클릭 시 닫기
        document.getElementById('newsModal').addEventListener('click', (e) => {
            if (e.target.id === 'newsModal') {
                closeModal();
            }
        });

        // 페이지 로드 시 뉴스 로드
        document.addEventListener('DOMContentLoaded', () => {
            loadNews();
        });

        // CSS 스타일 추가
        const style = document.createElement('style');
        style.textContent = `
            .line-clamp-2 {
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
            .line-clamp-3 {
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>

