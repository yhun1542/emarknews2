const https = require('https');
const http = require('http');

class AdvancedNewsSystem {
  constructor() {
    this.newsCache = new Map();
    this.translationCache = new Map();
    this.duplicateCache = new Set();
    this.trendingTopics = new Map();
    
    // ì†ŒìŠ¤ ì‹ ë¢°ë„
    this.sourceReliability = new Map([
      ['bbc-news', 0.95], ['reuters', 0.95], ['cnn', 0.85],
      ['bloomberg', 0.90], ['associated-press', 0.95],
      ['the-guardian-uk', 0.85], ['the-new-york-times', 0.90],
      ['the-washington-post', 0.85], ['abc-news', 0.80]
    ]);
    
    // YouTube ì±„ë„ (ìƒìœ„ 3ê°œë§Œ ì„ ë³„)
    this.youtubeChannels = [
      'UCupvZG-5ko_eiXAupbDfxWw', // CNN
      'UCV3Nm3T-XAgVhKH9jT0ViRg', // BBC News
      'UCeY0bbntWzzVIaj2z3QigXg'  // NBC News
    ];
    
    // ì•ˆì •ì ì¸ RSS í”¼ë“œ (2ê°œë§Œ)
    this.rssFeeds = [
      'https://feeds.bbci.co.uk/news/world/rss.xml',
      'https://www.theguardian.com/world/rss'
    ];
    
    this.stopWords = new Set([
      'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by'
    ]);
    
    console.log('ğŸš€ ë³‘ë ¬ ì²˜ë¦¬ ë‰´ìŠ¤ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
  }

  // ë¹ ë¥¸ HTTP ìš”ì²­ (ì§§ì€ íƒ€ì„ì•„ì›ƒ, ì¬ì‹œë„ ìµœì†Œí™”)
  async makeRequest(url, options = {}) {
    const timeout = options.timeout || 4000; // 4ì´ˆë¡œ ë‹¨ì¶•
    const maxRetries = options.maxRetries || 1; // ì¬ì‹œë„ 1íšŒë¡œ ì œí•œ
    
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        return await this._singleRequest(url, timeout);
      } catch (error) {
        if (attempt === maxRetries) {
          console.warn(`âŒ API ìš”ì²­ ì‹¤íŒ¨ (${attempt}íšŒ ì‹œë„): ${url.substring(0, 50)}...`);
          throw error;
        }
        await this._sleep(500); // ì¬ì‹œë„ ê°„ê²© ë‹¨ì¶•
      }
    }
  }

  _singleRequest(url, timeout) {
    return new Promise((resolve, reject) => {
      const protocol = url.startsWith('https:') ? https : http;
      
      const timer = setTimeout(() => {
        reject(new Error('íƒ€ì„ì•„ì›ƒ'));
      }, timeout);
      
      const req = protocol.get(url, { 
        headers: {
          'User-Agent': 'EmarkNews/3.0 (Fast News Aggregator)',
          'Accept': 'application/json, application/xml, text/xml, */*'
        }
      }, (res) => {
        let data = '';
        res.on('data', (chunk) => data += chunk);
        res.on('end', () => {
          clearTimeout(timer);
          try {
            if (res.headers['content-type']?.includes('application/json')) {
              resolve(JSON.parse(data));
            } else {
              resolve(data);
            }
          } catch (error) {
            reject(new Error(`íŒŒì‹± ì˜¤ë¥˜: ${error.message}`));
          }
        });
      });
      
      req.on('timeout', () => {
        clearTimeout(timer);
        req.destroy();
        reject(new Error('íƒ€ì„ì•„ì›ƒ'));
      });
      
      req.on('error', (error) => {
        clearTimeout(timer);
        reject(error);
      });
    });
  }

  _sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  // ë¹ ë¥¸ ë²ˆì—­ í•¨ìˆ˜ (ìºì‹œ ìš°ì„ , ê°„ë‹¨í•œ ë¡œì§)
  async translateText(text, isLongText = false) {
    if (!text || text.length < 5) return text;
    
    // ìºì‹œ í™•ì¸
    const cacheKey = text.substring(0, 50);
    if (this.translationCache.has(cacheKey)) {
      return this.translationCache.get(cacheKey);
    }
    
    try {
      let translatedText = text;
      
      // OpenAI ë²ˆì—­ (ë¹ ë¥¸ ì„¤ì •)
      if (process.env.OPENAI_API_KEY) {
        translatedText = await this.quickTranslateWithOpenAI(text, isLongText);
      } else {
        // ê¸°ë³¸ ë²ˆì—­ ì‚¬ìš©
        translatedText = this.basicTranslation(text);
      }
      
      // ìºì‹œ ì €ì¥ (í¬ê¸° ì œí•œ)
      if (this.translationCache.size < 100) {
        this.translationCache.set(cacheKey, translatedText);
      }
      
      return translatedText;
      
    } catch (error) {
      console.warn('ë²ˆì—­ ì‹¤íŒ¨, ê¸°ë³¸ ë²ˆì—­ ì‚¬ìš©:', error.message);
      return this.basicTranslation(text);
    }
  }

  // ë¹ ë¥¸ OpenAI ë²ˆì—­ (í† í° ìˆ˜ ìµœì†Œí™”)
  async quickTranslateWithOpenAI(text, isLongText) {
    const maxTokens = isLongText ? 300 : 100; // í† í° ìˆ˜ ì œí•œ
    const prompt = isLongText 
      ? `ë‹¤ìŒì„ í•œêµ­ì–´ë¡œ ë²ˆì—­: ${text.substring(0, 200)}...` // í…ìŠ¤íŠ¸ ê¸¸ì´ ì œí•œ
      : `í•œêµ­ì–´ë¡œ ë²ˆì—­: ${text}`;
    
    const requestBody = JSON.stringify({
      model: "gpt-3.5-turbo",
      messages: [
        {
          role: "system",
          content: "ê°„ë‹¨í•˜ê³  ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì£¼ì„¸ìš”."
        },
        {
          role: "user",
          content: prompt
        }
      ],
      max_tokens: maxTokens,
      temperature: 0.1 // ì¼ê´€ì„±ì„ ìœ„í•´ ë‚®ê²Œ ì„¤ì •
    });

    return new Promise((resolve, reject) => {
      const timer = setTimeout(() => {
        reject(new Error('ë²ˆì—­ íƒ€ì„ì•„ì›ƒ'));
      }, 3000); // 3ì´ˆ íƒ€ì„ì•„ì›ƒ

      const req = https.request({
        hostname: 'api.openai.com',
        path: '/v1/chat/completions',
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
          'Content-Type': 'application/json',
          'Content-Length': Buffer.byteLength(requestBody)
        }
      }, (res) => {
        let data = '';
        res.on('data', chunk => data += chunk);
        res.on('end', () => {
          clearTimeout(timer);
          try {
            const response = JSON.parse(data);
            if (response.choices && response.choices[0]) {
              resolve(response.choices[0].message.content.trim());
            } else {
              reject(new Error('OpenAI ì‘ë‹µ ì˜¤ë¥˜'));
            }
          } catch (error) {
            reject(error);
          }
        });
      });

      req.on('error', (error) => {
        clearTimeout(timer);
        reject(error);
      });
      
      req.write(requestBody);
      req.end();
    });
  }

  // ê¸°ë³¸ ë²ˆì—­ (ë¹ ë¥¸ í‚¤ì›Œë“œ ì¹˜í™˜)
  basicTranslation(text) {
    const translations = {
      'breaking news': 'ì†ë³´',
      'breaking': 'ì†ë³´',
      'update': 'ì—…ë°ì´íŠ¸',
      'report': 'ë³´ê³ ì„œ',
      'president': 'ëŒ€í†µë ¹',
      'government': 'ì •ë¶€',
      'economy': 'ê²½ì œ',
      'economic': 'ê²½ì œ',
      'technology': 'ê¸°ìˆ ',
      'tech': 'ê¸°ìˆ ',
      'health': 'ê±´ê°•',
      'medical': 'ì˜ë£Œ',
      'sports': 'ìŠ¤í¬ì¸ ',
      'world': 'ì„¸ê³„',
      'international': 'êµ­ì œ',
      'business': 'ë¹„ì¦ˆë‹ˆìŠ¤',
      'market': 'ì‹œì¥',
      'stock': 'ì£¼ì‹',
      'trade': 'ë¬´ì—­',
      'war': 'ì „ìŸ',
      'peace': 'í‰í™”',
      'crisis': 'ìœ„ê¸°',
      'emergency': 'ê¸´ê¸‰',
      'urgent': 'ê¸´ê¸‰'
    };
    
    let translated = text;
    for (const [en, ko] of Object.entries(translations)) {
      translated = translated.replace(new RegExp(`\\b${en}\\b`, 'gi'), ko);
    }
    
    return translated;
  }

  // í’ˆì§ˆ ì ìˆ˜ ê³„ì‚° (ê°„ì†Œí™”)
  calculateQualityScore(article) {
    let score = 5; // ê¸°ë³¸ ì ìˆ˜
    
    const titleLength = article.title?.length || 0;
    if (titleLength >= 20 && titleLength <= 100) score += 2;
    
    const contentLength = article.description?.length || 0;
    if (contentLength >= 50) score += 2;
    
    if (article.urlToImage) score += 1;
    
    const sourceId = article.source?.id || '';
    const reliability = this.sourceReliability.get(sourceId) || 0.5;
    score += Math.round(reliability * 5);
    
    const publishedAt = new Date(article.publishedAt);
    const hoursDiff = (new Date() - publishedAt) / (1000 * 60 * 60);
    if (hoursDiff <= 24) score += 2;
    
    return Math.min(score, 15);
  }

  // News API (ë¹ ë¥¸ ë²„ì „)
  async fetchNews(category = 'general', country = 'us') {
    const apiKey = process.env.NEWS_API_KEY;
    if (!apiKey) return [];

    const url = `https://newsapi.org/v2/top-headlines?country=${country}&category=${category}&pageSize=10&apiKey=${apiKey}`;
    
    try {
      const data = await this.makeRequest(url, { timeout: 5000 });
      if (data.status === 'error') throw new Error(data.message);
      return data.articles || [];
    } catch (error) {
      console.error(`News API ì˜¤ë¥˜ (${category}):`, error.message);
      return [];
    }
  }

  // YouTube ë‰´ìŠ¤ (ìˆ˜ì •ëœ URL)
  async fetchYouTubeNews() {
    const apiKey = process.env.YOUTUBE_API_KEY;
    if (!apiKey) return [];

    const articles = [];
    
    // ë³‘ë ¬ë¡œ YouTube ì±„ë„ ì²˜ë¦¬
    const channelPromises = this.youtubeChannels.map(async (channelId) => {
      try {
        const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&maxResults=2&order=date&type=video&key=${apiKey}`;
        const data = await this.makeRequest(url, { timeout: 4000 });
        
        if (data.items) {
          return data.items.map(item => {
            const title = item.snippet.title.toLowerCase();
            if (['news', 'breaking', 'report', 'update'].some(keyword => title.includes(keyword))) {
              // ì˜¬ë°”ë¥¸ YouTube URL í˜•ì‹ (ìˆ˜ì •ë¨)
              const videoUrl = `https://www.youtube.com/watch?v=${item.id.videoId}&cc_load_policy=1&cc_lang_pref=ko&hl=ko`;
              
              return {
                title: item.snippet.title,
                description: item.snippet.description || 'ë™ì˜ìƒ ë‰´ìŠ¤ì…ë‹ˆë‹¤.',
                url: videoUrl,
                urlToImage: item.snippet.thumbnails?.medium?.url,
                publishedAt: item.snippet.publishedAt,
                source: { id: 'youtube', name: item.snippet.channelTitle },
                isVideo: true
              };
            }
            return null;
          }).filter(Boolean);
        }
        return [];
      } catch (error) {
        console.warn(`YouTube ì±„ë„ ${channelId} ê±´ë„ˆëœ€:`, error.message);
        return [];
      }
    });
    
    const results = await Promise.all(channelPromises);
    results.forEach(channelArticles => {
      articles.push(...channelArticles);
    });
    
    return articles.slice(0, 5); // ìµœëŒ€ 5ê°œë§Œ
  }

  // RSS ë‰´ìŠ¤ (ë³‘ë ¬ ì²˜ë¦¬)
  async fetchRSSNews() {
    const feedPromises = this.rssFeeds.map(async (feedUrl) => {
      try {
        const xmlData = await this.makeRequest(feedUrl, { timeout: 4000 });
        return this.parseRSS(xmlData).slice(0, 3); // ê° í”¼ë“œë‹¹ 3ê°œë§Œ
      } catch (error) {
        console.warn(`RSS í”¼ë“œ ê±´ë„ˆëœ€ (${feedUrl}):`, error.message);
        return [];
      }
    });
    
    const results = await Promise.all(feedPromises);
    const articles = [];
    results.forEach(feedArticles => {
      articles.push(...feedArticles);
    });
    
    return articles;
  }

  parseRSS(xmlData) {
    const articles = [];
    const itemRegex = /<item[^>]*>(.*?)<\/item>/gs;
    
    let match;
    while ((match = itemRegex.exec(xmlData)) !== null && articles.length < 5) {
      try {
        const item = match[1];
        const title = this.extractXMLContent(item, 'title');
        const description = this.extractXMLContent(item, 'description');
        const link = this.extractXMLContent(item, 'link');
        const pubDate = this.extractXMLContent(item, 'pubDate');
        
        if (title && link) {
          articles.push({
            title: this.stripHtml(title),
            description: this.stripHtml(description) || 'ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.',
            url: link,
            publishedAt: pubDate || new Date().toISOString(),
            source: { id: 'rss', name: 'RSS Feed' }
          });
        }
      } catch (error) {
        continue;
      }
    }
    
    return articles;
  }

  extractXMLContent(xml, tag) {
    const regex = new RegExp(`<${tag}[^>]*><!\\[CDATA\\[(.*?)\\]\\]></${tag}>|<${tag}[^>]*>(.*?)</${tag}>`, 's');
    const match = regex.exec(xml);
    return match ? (match[1] || match[2] || '').trim() : '';
  }

  stripHtml(html) {
    return html ? html.replace(/<[^>]*>/g, '').replace(/&[^;]+;/g, ' ').trim() : '';
  }

  // ê°„ë‹¨í•œ ê¸°ì‚¬ ë¶„ì„
  async analyzeArticle(article) {
    const title = article.title?.toLowerCase() || '';
    const description = (article.description || '').toLowerCase();
    const text = `${title} ${description}`;
    
    // ë¹ ë¥¸ ì¹´í…Œê³ ë¦¬ ë¶„ì„
    let category = 'ì¼ë°˜';
    const categories = {
      'ì •ì¹˜': ['politic', 'election', 'government'],
      'ê²½ì œ': ['econom', 'market', 'business', 'finance'],
      'ê¸°ìˆ ': ['technolog', 'ai', 'tech', 'digital'],
      'ìŠ¤í¬ì¸ ': ['sport', 'game', 'match'],
      'ê±´ê°•': ['health', 'medical', 'hospital'],
      'êµ­ì œ': ['international', 'world', 'global']
    };
    
    for (const [cat, keywords] of Object.entries(categories)) {
      if (keywords.some(keyword => text.includes(keyword))) {
        category = cat;
        break;
      }
    }
    
    // ê°„ë‹¨í•œ ê¸´ê¸‰ë„/ì¤‘ìš”ë„ ê³„ì‚°
    let urgency = 2;
    if (text.match(/breaking|urgent|emergency|crisis/)) urgency = 5;
    else if (text.match(/important|major|significant/)) urgency = 4;
    else if (text.match(/update|latest|developing/)) urgency = 3;
    
    let importance = 3;
    if (text.match(/crisis|war|disaster|pandemic/)) importance = 5;
    else if (text.match(/president|minister|ceo|leader/)) importance = 4;
    
    let buzz = Math.min(urgency + Math.floor(Math.random() * 2), 5);
    
    return {
      category,
      urgency,
      importance,
      buzz,
      stars: Math.min(Math.round((urgency + importance) / 2), 5),
      keywords: this.extractKeywords(text),
      sentiment: this.analyzeSentiment(text),
      qualityScore: this.calculateQualityScore(article)
    };
  }

  extractKeywords(text) {
    const words = text.match(/\b\w{4,}\b/g) || [];
    const wordCount = new Map();
    
    words.forEach(word => {
      const lowerWord = word.toLowerCase();
      if (!this.stopWords.has(lowerWord)) {
        wordCount.set(word, (wordCount.get(word) || 0) + 1);
      }
    });
    
    return [...wordCount.entries()]
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3)
      .map(([word]) => word);
  }

  analyzeSentiment(text) {
    const positive = ['good', 'great', 'success', 'win', 'positive'];
    const negative = ['bad', 'crisis', 'fail', 'negative', 'decline'];
    
    let positiveCount = positive.filter(word => text.includes(word)).length;
    let negativeCount = negative.filter(word => text.includes(word)).length;
    
    if (positiveCount > negativeCount) return 'ê¸ì •';
    if (negativeCount > positiveCount) return 'ë¶€ì •';
    return 'ì¤‘ë¦½';
  }

  // ì¤‘ë³µ ê°ì§€ (ê°„ì†Œí™”)
  isDuplicate(title, threshold = 0.8) {
    for (const cachedTitle of this.duplicateCache) {
      if (this.calculateSimilarity(title, cachedTitle) > threshold) {
        return true;
      }
    }
    return false;
  }

  calculateSimilarity(str1, str2) {
    const set1 = new Set(str1.toLowerCase().split(/\s+/));
    const set2 = new Set(str2.toLowerCase().split(/\s+/));
    const intersection = new Set([...set1].filter(x => set2.has(x)));
    const union = new Set([...set1, ...set2]);
    return intersection.size / union.size;
  }

  // íŠ¸ë Œë”© í† í”½ ì—…ë°ì´íŠ¸ (ê°„ì†Œí™”)
  updateTrendingTopics(articles) {
    const wordCount = new Map();
    
    articles.slice(0, 20).forEach(article => { // ì²˜ë¦¬ëŸ‰ ì œí•œ
      const text = `${article.title} ${article.description || ''}`.toLowerCase();
      const words = text.match(/\b\w{4,}\b/g) || [];
      
      words.slice(0, 10).forEach(word => { // ë‹¨ì–´ ìˆ˜ ì œí•œ
        if (!this.stopWords.has(word)) {
          wordCount.set(word, (wordCount.get(word) || 0) + 1);
        }
      });
    });
    
    const sortedWords = [...wordCount.entries()]
      .sort((a, b) => b[1] - a[1])
      .slice(0, 8);
    
    this.trendingTopics.clear();
    sortedWords.forEach(([word, count]) => {
      this.trendingTopics.set(word, count);
    });
  }

  // ê³ ê¸‰ í•„í„°ë§ (ê°„ì†Œí™”)
  filterAndRankArticles(articles, maxCount = 5) {
    const qualityThreshold = parseInt(process.env.QUALITY_THRESHOLD) || 6; // ë‚®ì¶¤
    const duplicateThreshold = parseFloat(process.env.DUPLICATE_THRESHOLD) || 0.8;
    
    const scoredArticles = articles.map(article => ({
      ...article,
      qualityScore: this.calculateQualityScore(article)
    }));
    
    const qualityFiltered = scoredArticles.filter(article => 
      article.qualityScore >= qualityThreshold &&
      article.title &&
      article.title !== '[Removed]' &&
      article.description &&
      article.description.length > 10 // ìµœì†Œ ê¸¸ì´ ë‹¨ì¶•
    );
    
    const uniqueArticles = [];
    for (const article of qualityFiltered) {
      if (!this.isDuplicate(article.title, duplicateThreshold)) {
        uniqueArticles.push(article);
        this.duplicateCache.add(article.title);
        if (uniqueArticles.length >= maxCount * 2) break; // ì¡°ê¸° ì¢…ë£Œ
      }
    }
    
    uniqueArticles.sort((a, b) => b.qualityScore - a.qualityScore);
    return uniqueArticles.slice(0, maxCount);
  }

  // ë©”ì¸ ìˆ˜ì§‘ í•¨ìˆ˜ (ë³‘ë ¬ ì²˜ë¦¬ ìµœì í™”)
  async collectAllNews() {
    const cacheKey = 'all_news';
    const cacheExpiry = (parseInt(process.env.CACHE_EXPIRY_MINUTES) || 8) * 60 * 1000; // 8ë¶„ìœ¼ë¡œ ë‹¨ì¶•
    
    // ìºì‹œ í™•ì¸
    if (this.newsCache.has(cacheKey)) {
      const cached = this.newsCache.get(cacheKey);
      if (Date.now() - cached.timestamp < cacheExpiry) {
        console.log('ğŸ“¦ ìºì‹œëœ ë‰´ìŠ¤ ë°ì´í„° ì‚¬ìš©');
        return cached.data;
      }
    }
    
    console.log('ğŸ”„ ë³‘ë ¬ ë‰´ìŠ¤ ìˆ˜ì§‘ ì‹œì‘...');
    const startTime = Date.now();
    
    try {
      // ëª¨ë“  ì†ŒìŠ¤ë¥¼ ë³‘ë ¬ë¡œ ìˆ˜ì§‘ (íƒ€ì„ì•„ì›ƒ ì„¤ì •)
      const sourcePromises = [
        this.fetchNews('general', 'us'),
        this.fetchNews('business', 'us'),
        this.fetchNews('technology', 'us'),
        this.fetchYouTubeNews(),
        this.fetchRSSNews(),
        this.fetchNews('general', 'kr'),
        this.fetchNews('general', 'jp')
      ];
      
      // ì „ì²´ íƒ€ì„ì•„ì›ƒ ì„¤ì • (15ì´ˆ)
      const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('ì „ì²´ ìˆ˜ì§‘ íƒ€ì„ì•„ì›ƒ')), 15000);
      });
      
      const results = await Promise.race([
        Promise.allSettled(sourcePromises),
        timeoutPromise
      ]);
      
      const extractValue = (result) => result.status === 'fulfilled' ? result.value : [];
      
      const allWorldArticles = [
        ...extractValue(results[0]),
        ...extractValue(results[1]),
        ...extractValue(results[2]),
        ...extractValue(results[3]),
        ...extractValue(results[4])
      ];
      
      console.log(`ğŸ“Š ìˆ˜ì§‘ ì™„ë£Œ: ì„¸ê³„ ${allWorldArticles.length}, í•œêµ­ ${extractValue(results[5]).length}, ì¼ë³¸ ${extractValue(results[6]).length}`);
      
      // íŠ¸ë Œë”© í† í”½ ì—…ë°ì´íŠ¸
      this.updateTrendingTopics(allWorldArticles);
      
      // ê° ì„¹ì…˜ì„ ë³‘ë ¬ë¡œ ì²˜ë¦¬
      const sectionPromises = [
        this.processAdvancedSection(allWorldArticles, 4, 'ì„¸ê³„ë‰´ìŠ¤'),
        this.processAdvancedSection(extractValue(results[5]), 4, 'í•œêµ­ë‰´ìŠ¤'),
        this.processAdvancedSection(extractValue(results[6]), 4, 'ì¼ë³¸ë‰´ìŠ¤')
      ];
      
      const processedSections = await Promise.all(sectionPromises);
      
      const result = {
        sections: {
          world: processedSections[0],
          korea: processedSections[1],
          japan: processedSections[2]
        },
        trending: [...this.trendingTopics.entries()].slice(0, 8),
        lastUpdated: new Date().toISOString(),
        totalArticles: processedSections.reduce((sum, section) => sum + section.length, 0),
        systemStatus: this.getSystemStatus()
      };
      
      // ìºì‹œ ì €ì¥
      this.newsCache.set(cacheKey, {
        data: result,
        timestamp: Date.now()
      });
      
      const duration = Date.now() - startTime;
      console.log(`âœ… ë³‘ë ¬ ë‰´ìŠ¤ ì²˜ë¦¬ ì™„ë£Œ: ${duration}ms`);
      return result;
      
    } catch (error) {
      console.error('âŒ ë‰´ìŠ¤ ìˆ˜ì§‘ ì˜¤ë¥˜:', error);
      return this.getDefaultNewsData();
    }
  }

  // ë³‘ë ¬ ì²˜ë¦¬ ì„¹ì…˜ (í•µì‹¬ ê°œì„ )
  async processAdvancedSection(articles, maxCount, sectionName) {
    if (!articles || articles.length === 0) return [];
    
    console.log(`ğŸ“° ${sectionName} ë³‘ë ¬ ì²˜ë¦¬ ì‹œì‘: ${articles.length}ê°œ`);
    const startTime = Date.now();
    
    try {
      // 1ë‹¨ê³„: í•„í„°ë§ (ë¹ ë¥´ê²Œ)
      const filteredArticles = this.filterAndRankArticles(articles, maxCount * 2);
      
      if (filteredArticles.length === 0) return [];
      
      // 2ë‹¨ê³„: ë³‘ë ¬ ë²ˆì—­ ë° ë¶„ì„ (í•µì‹¬ ê°œì„ )
      const analyzedArticlesPromises = filteredArticles.map(async (article) => {
        try {
          // ë²ˆì—­ê³¼ ë¶„ì„ì„ ë³‘ë ¬ë¡œ ì‹¤í–‰
          const [translatedTitle, translatedDescription, analysis] = await Promise.all([
            this.translateText(article.title, false),
            this.translateText(article.description || 'ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', true),
            this.analyzeArticle(article)
          ]);
          
          return {
            id: this.generateId(article),
            title: translatedTitle,
            originalTitle: article.title,
            description: translatedDescription,
            originalDescription: article.description,
            url: article.url,
            image: article.urlToImage,
            publishedAt: article.publishedAt,
            source: article.source?.name || 'Unknown',
            isVideo: article.isVideo || false,
            ...analysis,
            finalScore: analysis.qualityScore + analysis.urgency + analysis.importance
          };
          
        } catch (error) {
          console.warn(`ê¸°ì‚¬ ì²˜ë¦¬ ì‹¤íŒ¨: ${article.title?.substring(0, 30)}...`);
          return null;
        }
      });
      
      // ëª¨ë“  ë²ˆì—­/ë¶„ì„ì„ ë³‘ë ¬ë¡œ ëŒ€ê¸°
      const analyzedArticles = (await Promise.all(analyzedArticlesPromises))
        .filter(article => article !== null);
      
      const duration = Date.now() - startTime;
      console.log(`âœ… ${sectionName} ë³‘ë ¬ ì²˜ë¦¬ ì™„ë£Œ: ${analyzedArticles.length}ê°œ, ${duration}ms`);
      
      return analyzedArticles
        .sort((a, b) => b.finalScore - a.finalScore)
        .slice(0, maxCount);
        
    } catch (error) {
      console.error(`âŒ ${sectionName} ì²˜ë¦¬ ì˜¤ë¥˜:`, error);
      return [];
    }
  }

  generateId(article) {
    return require('crypto')
      .createHash('md5')
      .update((article.title || '') + (article.url || ''))
      .digest('hex')
      .substring(0, 8);
  }

  getSystemStatus() {
    return {
      cacheSize: this.newsCache.size,
      translationCacheSize: this.translationCache.size,
      duplicateCacheSize: this.duplicateCache.size,
      trendingTopicsCount: this.trendingTopics.size,
      lastUpdate: new Date().toISOString(),
      apiKeys: {
        newsApi: !!process.env.NEWS_API_KEY,
        skyworkAi: !!process.env.SKYWORK_API_KEY,
        openAi: !!process.env.OPENAI_API_KEY,
        youtubeApi: !!process.env.YOUTUBE_API_KEY
      },
      environment: process.env.NODE_ENV || 'development',
      version: '3.0.0-parallel'
    };
  }

  getDefaultNewsData() {
    return {
      sections: {
        world: [{
          id: 'default-1',
          title: 'EmarkNews ë³‘ë ¬ ì²˜ë¦¬ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ',
          description: 'ìµœì í™”ëœ ë³‘ë ¬ ì²˜ë¦¬ë¡œ ë¹ ë¥´ê³  ì•ˆì •ì ì¸ ë‰´ìŠ¤ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤. AI ë²ˆì—­ê³¼ ë¶„ì„ì´ ë™ì‹œì— ì§„í–‰ë˜ì–´ ë¡œë”© ì‹œê°„ì´ ëŒ€í­ ë‹¨ì¶•ë˜ì—ˆìŠµë‹ˆë‹¤.',
          url: '#', image: null, publishedAt: new Date().toISOString(),
          source: 'EmarkNews', category: 'ì‹œìŠ¤í…œ', urgency: 3, importance: 3,
          buzz: 3, stars: 4, keywords: ['ë³‘ë ¬ì²˜ë¦¬', 'ìµœì í™”'], sentiment: 'ê¸ì •'
        }],
        korea: [{
          id: 'default-2',
          title: 'í•œêµ­ ë‰´ìŠ¤ ê³ ì† ì²˜ë¦¬ ì¤‘',
          description: 'ë³‘ë ¬ ë²ˆì—­ ì‹œìŠ¤í…œìœ¼ë¡œ í•œêµ­ ë‰´ìŠ¤ë¥¼ ë¹ ë¥´ê²Œ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
          url: '#', image: null, publishedAt: new Date().toISOString(),
          source: 'EmarkNews', category: 'ì‹œìŠ¤í…œ', urgency: 2, importance: 2,
          buzz: 2, stars: 3, keywords: ['í•œêµ­', 'ê³ ì†'], sentiment: 'ì¤‘ë¦½'
        }],
        japan: [{
          id: 'default-3',
          title: 'ì¼ë³¸ ë‰´ìŠ¤ ë™ì‹œ ë²ˆì—­ ì§„í–‰',
          description: 'ì—¬ëŸ¬ ê¸°ì‚¬ë¥¼ ë™ì‹œì— ë²ˆì—­í•˜ì—¬ ì²˜ë¦¬ ì†ë„ë¥¼ í–¥ìƒì‹œì¼°ìŠµë‹ˆë‹¤.',
          url: '#', image: null, publishedAt: new Date().toISOString(),
          source: 'EmarkNews', category: 'ì‹œìŠ¤í…œ', urgency: 2, importance: 2,
          buzz: 2, stars: 3, keywords: ['ì¼ë³¸', 'ë™ì‹œë²ˆì—­'], sentiment: 'ì¤‘ë¦½'
        }]
      },
      trending: [['ë³‘ë ¬ì²˜ë¦¬', 8], ['ìµœì í™”', 6], ['ë²ˆì—­', 5], ['ë‰´ìŠ¤', 4]],
      lastUpdated: new Date().toISOString(),
      totalArticles: 3,
      systemStatus: this.getSystemStatus()
    };
  }

  clearCache() {
    this.newsCache.clear();
    this.translationCache.clear();
    this.duplicateCache.clear();
    console.log('ğŸ—‘ï¸ ë³‘ë ¬ ì²˜ë¦¬ ìºì‹œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
  }
}

module.exports = AdvancedNewsSystem;

